---
import BaseLayout from "../layouts/BaseLayout.astro";
import SnippetCard from "../components/SnippetCard.astro";
import { loadSnippets } from "../lib/csv";

const snippets = loadSnippets();
const categories = Array.from(new Set(snippets.map((snippet) => snippet.category)));
const types = Array.from(new Set(snippets.map((snippet) => snippet.type)));
---
<BaseLayout title="Astro Snippet Library" description="CSV ã‹ã‚‰èª­ã¿è¾¼ã‚€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒ‹ãƒšãƒƒãƒˆé›†">
  <section class="grid gap-6 rounded-3xl border border-white/10 bg-white/5 p-6 shadow-xl shadow-indigo-500/10">
    <div class="flex flex-wrap items-center gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-indigo-200">Search</p>
        <h2 class="text-2xl font-bold">ã‚¹ãƒ‹ãƒšãƒƒãƒˆæ¤œç´¢</h2>
      </div>
      <div class="ml-auto flex flex-wrap gap-3 text-sm text-slate-200/80">
        <span class="rounded-full bg-white/10 px-3 py-1 ring-1 ring-white/10">{snippets.length} ä»¶</span>
        <span id="result-count" class="rounded-full bg-indigo-500/20 px-3 py-1 ring-1 ring-indigo-400/40">{snippets.length} ä»¶ãƒ’ãƒƒãƒˆ</span>
      </div>
    </div>
    <div class="grid gap-3 sm:grid-cols-[2fr_1fr_1fr]">
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ”</span>
        <input
          id="search"
          type="search"
          placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ãƒ»ã‚¿ã‚°ãƒ»ã‚³ãƒ¼ãƒ‰)"
          class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
        />
      </label>
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ“</span>
        <select id="category" class="w-full bg-transparent text-sm outline-none">
          <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
          {categories.map((category) => (
            <option value={category}>{category}</option>
          ))}
        </select>
      </label>
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ·ï¸</span>
        <select id="type" class="w-full bg-transparent text-sm outline-none">
          <option value="">ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—</option>
          {types.map((type) => (
            <option value={type}>{type}</option>
          ))}
        </select>
      </label>
    </div>

    <div id="snippet-list" class="grid gap-4 sm:grid-cols-2">
      {snippets.map((snippet) => (
        <SnippetCard snippet={snippet} />
      ))}
    </div>
  </section>

  <script type="module">
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.querySelector<HTMLInputElement>("#search");
      const categorySelect = document.querySelector<HTMLSelectElement>("#category");
      const typeSelect = document.querySelector<HTMLSelectElement>("#type");
      const cards = Array.from(document.querySelectorAll<HTMLElement>("[data-snippet]"));
      const resultCount = document.querySelector<HTMLElement>("#result-count");

      const applyFilters = () => {
        const keyword = searchInput?.value.trim().toLowerCase() ?? "";
        const category = categorySelect?.value ?? "";
        const type = typeSelect?.value ?? "";

        let visible = 0;
        cards.forEach((card) => {
          const matchesKeyword = keyword
            ? ["title", "description", "tags", "code"].some((field) =>
                card.dataset[field]?.includes(keyword),
              )
            : true;
          const matchesCategory = category ? card.dataset.category === category : true;
          const matchesType = type ? card.dataset.type === type : true;
          const show = matchesKeyword && matchesCategory && matchesType;
          card.style.display = show ? "flex" : "none";
          if (show) visible += 1;
        });

        if (resultCount) {
          resultCount.textContent = `${visible} ä»¶ãƒ’ãƒƒãƒˆ`;
        }
      };

      [searchInput, categorySelect, typeSelect].forEach((el) => el?.addEventListener("input", applyFilters));
      applyFilters();

    });
  </script>
</BaseLayout>
